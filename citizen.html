<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Civic Engagement Portal</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f8f9fa; }
header { background: #343a40; color: white; padding: 1rem; text-align: center; position: relative; }
main { padding: 1rem; }
.hidden { display: none; }
.card { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 1rem; margin-bottom: 1rem; }
input, textarea, select { width: 100%; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #ccc; border-radius: 5px; }
button { cursor: pointer; background: #6c757d; border: none; color: white; padding: 0.5rem 1rem; border-radius: 5px; margin: 0.25rem; }
button:hover { background: #5a6268; }
a.link { color: #007bff; cursor: pointer; display: block; margin-top: 8px; font-size: 14px; }
.report { border: 1px solid #ddd; border-radius: 10px; padding: 1rem; margin: 0.5rem; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: 200px; text-align: center; }
.muted { color: gray; font-size: 0.9em; }
.attachments img, .attachments video { max-width: 150px; display: block; margin: 5px auto; }
.role-container { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 1rem; }
.role-box { width: 150px; height: 150px; background: #fff; border-radius: 12px; padding: 1rem; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 1px solid #ddd; cursor: pointer; transition: 0.3s; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
.role-box:hover { background: #f1f1f1; transform: scale(1.05); }
.role-box h3 { margin: 0; font-size: 16px; }
.role-box span.icon { font-size: 36px; margin-bottom: 10px; }
#citWelcome { display: flex; justify-content: space-between; align-items: center; font-size: 18px; background: linear-gradient(90deg, #6c757d, #343a40); padding: 14px 18px; border-radius: 12px; color: white; font-weight: bold; box-shadow: 0 3px 8px rgba(0,0,0,0.2); }
#citRole { font-size: 16px; font-style: italic; color: #dcdcdc; }
.section-subtitle { font-size: 20px; margin: 1rem 0; border-left: 4px solid #6c757d; padding-left: 8px; color: #343a40; }
.report-form { background: #fefefe; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
.menu-btn { position: absolute; top: 10px; left: 10px; font-size: 24px; cursor: pointer; background: none; border: none; color: white; display: none; }
#sideMenu { height: 100%; width: 0; position: fixed; top: 0; left: 0; background: #fff; overflow-x: hidden; transition: 0.3s; box-shadow: 2px 0 8px rgba(0,0,0,0.1); }
#sideMenu a { padding: 15px 20px; display: flex; align-items: center; gap: 10px; text-decoration: none; color: #333; border-bottom: 1px solid #eee; font-size: 16px; }
#sideMenu a:hover { background: #f8f9fa; }
#sideMenu .logout { color: red; }
#sideMenu .closebtn { position: absolute; top: 10px; right: 20px; font-size: 24px; color: #333; cursor: pointer; }
#personalDetails { padding: 10px; font-size: 14px; border-top: 1px solid #eee; }
#myReports, #pendingReports { display: flex; flex-wrap: wrap; gap: 1rem; }
.star-rating { display: flex; justify-content: center; gap: 2px; margin: 5px 0; cursor: pointer; }
.star-rating span { font-size: 20px; color: gold; }
</style>
</head>
<body>
<header>
  <button class="menu-btn" id="menuBtn" onclick="openMenu()">‚ò∞</button>
  <h1>Civic Engagement Portal</h1>
</header>

<div id="sideMenu">
  <span class="closebtn" onclick="closeMenu()">√ó</span>
  <a href="#" onclick="togglePersonalDetails()">üë§ Personal Details</a>
  <div id="personalDetails" class="hidden"></div>
  <a href="#" onclick="alert('Help Section: Contact support at help@portal.com')">‚ùì Help</a>
  <a href="#" onclick="alert('Terms and Conditions apply...')">üìÑ Terms & Conditions</a>
  <a href="#" class="logout" onclick="logoutCitizen()">üö™ Logout</a>
</div>

<main>
  <!-- Citizen Login -->
  <section id="citizenLogin" class="card">
    <h2>Citizen Login</h2>
    <input type="text" id="citName" placeholder="Name">
    <input type="text" id="citAadhaar" placeholder="Aadhaar (12 digits)">
    <input type="password" id="citPassword" placeholder="Password">
    <button onclick="citizenLogin()">Login</button>
    <a class="link" onclick="showSection('forgotPassword')">Forgot Password?</a>
    <a class="link" onclick="showSection('createAccount')">Create Account</a>
    <button onclick="goBack()">Back</button>
  </section>

  <!-- Create Account -->
  <section id="createAccount" class="card hidden">
    <h2>Create Account</h2>
    <input type="text" id="newName" placeholder="Full Name">
    <input type="text" id="newAadhaar" placeholder="Aadhaar (12 digits)">
    <select id="newGender">
      <option value="">Select Gender</option>
      <option>Male</option><option>Female</option><option>Other</option>
    </select>
    <input type="date" id="newDOB" placeholder="Date of Birth">
    <input type="text" id="newMobile" placeholder="Mobile Number">
    <input type="password" id="newPassword" placeholder="Password">
    <button onclick="createCitizenAccount()">Register</button>
    <button onclick="showSection('citizenLogin')">Back</button>
  </section>

  <!-- Forgot Password -->
  <section id="forgotPassword" class="card hidden">
    <h2>Forgot Password</h2>
    <input type="text" id="fpAadhaar" placeholder="Enter Aadhaar">
    <button onclick="sendOTP()">Send OTP</button>
    <div id="otpSection" class="hidden">
      <input type="text" id="fpOTP" placeholder="Enter OTP">
      <input type="password" id="fpNewPassword" placeholder="New Password">
      <button onclick="resetPassword()">Reset Password</button>
    </div>
    <button onclick="showSection('citizenLogin')">Back</button>
  </section>

  <!-- Citizen Dashboard -->
  <section id="citizenDashboard" class="card hidden">
    <div id="citWelcome"><span id="citNameDisplay"></span> <span id="citRole"></span></div>

    <!-- Icons Page -->
    <div id="citizenIcons">
      <div class="role-container" style="margin:1rem 0;">
        <div class="role-box" onclick="openCitizenPage('reportFormSec')">
          <span class="icon">üìë</span><h3>Reports</h3>
        </div>
        <div class="role-box" onclick="openCitizenPage('myReportsSec')">
          <span class="icon">üìù</span><h3>My Reports</h3>
        </div>
      </div>
    </div>

    <!-- Submit Report Page with Location -->
    <div id="reportFormSec" class="hidden">
      <button onclick="backToIcons()">‚¨Ö Back</button>
      <div class="report-form">
        <h3 class="section-subtitle">Submit Report</h3>
        <input type="text" id="reportTitle" placeholder="Report Title">
        <textarea id="reportDesc" placeholder="Description"></textarea>
        <input type="file" id="reportFiles" multiple>
        <button onclick="useMyLocation()">üìç Use My Current Location</button>
        <p id="locationDisplay" class="muted"></p>
        <button onclick="submitReport()">Submit</button>
      </div>
    </div>

    <!-- My Reports Page -->
    <div id="myReportsSec" class="hidden">
      <button onclick="backToIcons()">‚¨Ö Back</button>
      <h3 class="section-subtitle">My Reports</h3>
      <div id="myReports"></div>
    </div>
  </section>

  <!-- Authority Login -->
  <section id="authorityLogin" class="card hidden">
    <h2>Authority Login</h2>
    <input type="text" id="authUser" placeholder="Username">
    <input type="password" id="authPass" placeholder="Password">
    <button onclick="authorityLogin()">Login</button>
    <button onclick="goBack()">Back</button>
  </section>

  <!-- Authority Dashboard -->
  <section id="authorityDashboard" class="card hidden">
    <div id="citWelcome"><span id="authNameDisplay"></span> <span id="citRole">Authority</span></div>
    <button onclick="logoutAuthority()">Logout</button>
    <h3>Pending Reports</h3>
    <div id="pendingReports"></div>
    <h3>Chat with Citizens</h3>
    <div id="chatBox" style="border:1px solid #ccc; height:200px; overflow:auto; padding:5px;"></div>
    <input type="text" id="chatMsg" placeholder="Type message"><button onclick="sendChat()">Send</button>
  </section>
</main>

<script>
/* All JS unchanged from your original code */
let currentCitizen = null;
let currentAuthority = false;
let generatedOTP = null;
let currentLocation = null;

// On page load, restore session if present
(function initFromStorage(){
  try {
    const saved = localStorage.getItem('currentCitizen');
    if(saved){
      currentCitizen = JSON.parse(saved);
      document.getElementById('citNameDisplay').innerText = `Welcome, ${currentCitizen.name}`;
      document.getElementById('citRole').innerText = 'Citizen';
    }
  } catch(e){ /* ignore */ }
})();

function showSection(id) {
  document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.getElementById('menuBtn').style.display = (id === 'citizenDashboard') ? 'block' : 'none';
}
function goBack(){ showSection('citizenLogin'); } // changed back to login
function maskAadhaar(aad){ return "XXXXXXXX" + aad.slice(-4); }

function createCitizenAccount(){
  const name=document.getElementById('newName').value.trim();
  const aad=document.getElementById('newAadhaar').value.trim();
  const gender=document.getElementById('newGender').value;
  const dob=document.getElementById('newDOB').value;
  const mobile=document.getElementById('newMobile').value.trim();
  const password=document.getElementById('newPassword').value.trim();
  if(!name || !/^\d{12}$/.test(aad) || !gender || !dob || !/^\d{10}$/.test(mobile) || !password){
    alert("Fill all details correctly"); return;
  }
  let users=JSON.parse(localStorage.getItem('citizens')||'[]');
  if(users.find(u=>u.aad===aad)){ alert("Account already exists"); return; }
  users.push({name,aad,gender,dob,mobile,password});
  localStorage.setItem('citizens',JSON.stringify(users));
  alert("Account created successfully!");
  showSection('citizenLogin');
}

function citizenLogin(){
  const name=document.getElementById('citName').value.trim();
  const aad=document.getElementById('citAadhaar').value.trim();
  const password=document.getElementById('citPassword').value.trim();
  let users=JSON.parse(localStorage.getItem('citizens')||'[]');
  let user=users.find(u=>u.name===name && u.aad===aad && u.password===password);
  if(!user){ alert("Invalid login"); return; }
  currentCitizen=user;
  localStorage.setItem('currentCitizen',JSON.stringify(currentCitizen));
  document.getElementById('citNameDisplay').innerText=`Welcome, ${name}`;
  document.getElementById('citRole').innerText='Citizen';
  showSection('citizenDashboard');
  backToIcons();
  loadMyReports();
}
function logoutCitizen(){ currentCitizen=null; localStorage.removeItem('currentCitizen'); showSection('citizenLogin'); closeMenu(); }

function sendOTP(){
  const aad=document.getElementById('fpAadhaar').value.trim();
  let users=JSON.parse(localStorage.getItem('citizens')||'[]');
  let user=users.find(u=>u.aad===aad);
  if(!user){ alert("No account with this Aadhaar"); return; }
  generatedOTP=Math.floor(1000+Math.random()*9000);
  alert("OTP sent: "+generatedOTP);
  document.getElementById('otpSection').classList.remove('hidden');
}
function resetPassword(){
  const aad=document.getElementById('fpAadhaar').value.trim();
  const otp=document.getElementById('fpOTP').value.trim();
  const newPass=document.getElementById('fpNewPassword').value.trim();
  if(otp!=generatedOTP){ alert("Invalid OTP"); return; }
  let users=JSON.parse(localStorage.getItem('citizens')||'[]');
  users=users.map(u=>u.aad===aad?{...u,password:newPass}:u);
  localStorage.setItem('citizens',JSON.stringify(users));
  alert("Password reset successful!");
  showSection('citizenLogin');
}

function togglePersonalDetails(){
  const box=document.getElementById('personalDetails');
  if(box.classList.contains('hidden')){
    if(currentCitizen){
      box.classList.remove('hidden');
      box.innerHTML=`<h3 style="margin:10px 0;">Personal Details</h3>
        <p><b>Name:</b> ${currentCitizen.name}</p>
        <p><b>Aadhaar:</b> ${maskAadhaar(currentCitizen.aad)}</p>
        <p><b>Gender:</b> ${currentCitizen.gender}</p>
        <p><b>DOB:</b> ${currentCitizen.dob}</p>
        <p><b>Mobile:</b> ${currentCitizen.mobile}</p>`;
    } else alert("No citizen logged in.");
  } else box.classList.add('hidden');
}

function openCitizenPage(id){
  document.getElementById('citizenIcons').classList.add('hidden');
  document.getElementById('reportFormSec').classList.add('hidden');
  document.getElementById('myReportsSec').classList.add('hidden');
  document.getElementById(id).classList.remove('hidden');
}
function backToIcons(){
  document.getElementById('reportFormSec').classList.add('hidden');
  document.getElementById('myReportsSec').classList.add('hidden');
  document.getElementById('citizenIcons').classList.remove('hidden');
}

function useMyLocation() {
  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser.");
    return;
  }
  document.getElementById('locationDisplay').innerText = "Retrieving location...";
  navigator.geolocation.getCurrentPosition(
    async (position) => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      currentLocation = { latitude: lat.toFixed(6), longitude: lon.toFixed(6) };
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&addressdetails=1`;
        const res = await fetch(url, { method: 'GET' });
        if (!res.ok) throw new Error('Reverse geocode failed');
        const data = await res.json();
        const addr = data.address || {};
        const area = addr.suburb || addr.neighbourhood || addr.hamlet || addr.village || addr.town || addr.city || addr.county || "";
        const district = addr.county || addr.district || addr.region || addr['state_district'] || "";
        const state = addr.state || addr.state_district || "";
        currentLocation.area = area;
        currentLocation.district = district;
        currentLocation.state = state;
        let display = `Current Location: Latitude ${currentLocation.latitude}, Longitude ${currentLocation.longitude}`;
        if(area) display += `\nArea: ${area}`;
        if(district) display += `\nDistrict: ${district}`;
        if(state) display += `\nState: ${state}`;
        document.getElementById('locationDisplay').innerText = display;
      } catch (err) {
        document.getElementById('locationDisplay').innerText = `Current Location: Latitude ${currentLocation.latitude}, Longitude ${currentLocation.longitude}`;
      }
    },
    (error) => {
      alert("Unable to retrieve your location. Please allow location access.");
      document.getElementById('locationDisplay').innerText = "";
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
  );
}

function submitReport(){
  if(!currentCitizen) { alert('Please login first'); return; }
  const title=document.getElementById('reportTitle').value.trim();
  const desc=document.getElementById('reportDesc').value.trim();
  const files=document.getElementById('reportFiles').files;
  if(!title||!desc){ alert('Fill title and description'); return; }
  const reports=JSON.parse(localStorage.getItem('reports')||'[]');
  const id=Date.now();
  const attachments=[];
  for(let f of files) attachments.push({name:f.name,type:f.type,data:URL.createObjectURL(f)});
  const locationToSave = currentLocation ? JSON.parse(JSON.stringify(currentLocation)) : null;
  reports.push({
    id,
    title,
    desc,
    citizenName: currentCitizen.name,
    citizenAad: currentCitizen.aad,
    attachments,
    status: 'pending',
    time: new Date().toLocaleString(),
    feedback: '',
    location: locationToSave
  });
  localStorage.setItem('reports',JSON.stringify(reports));
  alert('Report submitted');
  document.getElementById('reportTitle').value='';
  document.getElementById('reportDesc').value='';
  document.getElementById('reportFiles').value='';
  document.getElementById('locationDisplay').innerText = '';
  currentLocation = null;
  loadMyReports();
}

function loadMyReports(){
  if(!currentCitizen) return;
  const reports=JSON.parse(localStorage.getItem('reports')||'[]');
  const mine=reports.filter(r=>r.citizenAad===currentCitizen.aad);
  const div=document.getElementById('myReports'); div.innerHTML='';
  mine.forEach(r=>{
    let inner=`<div class='report'><strong>${escapeHtml(r.title)}</strong><br><small>${r.time}</small><p>${escapeHtml(r.desc)}</p>`;
    if(r.attachments && r.attachments.length){
      inner+=`<div class='attachments'>`;
      r.attachments.forEach(a=>{
        if(a.type && a.type.startsWith('image')) inner+=`<img src='${a.data}' alt='${escapeHtml(a.name)}'>`;
        else inner+=`<video src='${a.data}' controls></video>`;
      });
      inner+=`</div>`;
    }
    if(r.location){
      inner+=`<p class="muted">Location: Latitude ${r.location.latitude}, Longitude ${r.location.longitude}</p>`;
      if(r.location.area) inner+=`<p class="muted">Area: ${escapeHtml(r.location.area)}</p>`;
      if(r.location.district) inner+=`<p class="muted">District: ${escapeHtml(r.location.district)}</p>`;
      if(r.location.state) inner+=`<p class="muted">State: ${escapeHtml(r.location.state)}</p>`;
    }
    inner+=`<p>Status: <b>${r.status}</b></p>
      <textarea placeholder="Provide feedback" onchange="saveFeedback(${r.id}, this.value)">${escapeHtml(r.feedback||'')}</textarea>
      </div>`;
    div.innerHTML+=inner;
  });
}

function saveFeedback(id,val){
  const reports=JSON.parse(localStorage.getItem('reports')||'[]');
  reports.forEach(r=>{ if(r.id===id) r.feedback=val; });
  localStorage.setItem('reports',JSON.stringify(reports));
}

function openMenu(){ document.getElementById('sideMenu').style.width='250px'; }
function closeMenu(){ document.getElementById('sideMenu').style.width='0'; }

function authorityLogin(){
  const u=document.getElementById('authUser').value.trim();
  const p=document.getElementById('authPass').value.trim();
  if(u==='admin' && p==='admin'){ currentAuthority=true; document.getElementById('authNameDisplay').innerText='Authority Admin'; showSection('authorityDashboard'); loadPendingReports(); }
  else alert('Invalid login');
}
function logoutAuthority(){ currentAuthority=false; showSection('citizenLogin'); }
function loadPendingReports(){
  const reports=JSON.parse(localStorage.getItem('reports')||'[]');
  const div=document.getElementById('pendingReports'); div.innerHTML='';
  reports.filter(r=>r.status==='pending').forEach(r=>{
    let html = `<div class='report'><strong>${escapeHtml(r.title)}</strong><p>${escapeHtml(r.desc)}</p>`;
    if(r.location){
      html += `<p class="muted">Lat ${r.location.latitude}, Lon ${r.location.longitude}</p>`;
      if(r.location.area) html += `<p class="muted">Area: ${escapeHtml(r.location.area)}</p>`;
      if(r.location.district) html += `<p class="muted">District: ${escapeHtml(r.location.district)}</p>`;
      if(r.location.state) html += `<p class="muted">State: ${escapeHtml(r.location.state)}</p>`;
    }
    html += `<button onclick="updateStatus(${r.id},'in-progress')">In Progress</button>
      <button onclick="updateStatus(${r.id},'resolved')">Resolved</button></div>`;
    div.innerHTML += html;
  });
}
function updateStatus(id,status){
  let reports=JSON.parse(localStorage.getItem('reports')||'[]');
  reports=reports.map(r=>r.id===id?{...r,status}:r);
  localStorage.setItem('reports',JSON.stringify(reports));
  loadPendingReports();
}

function sendChat(){
  const msg=document.getElementById('chatMsg').value.trim();
  if(!msg) return;
  const box=document.getElementById('chatBox');
  box.innerHTML+=`<div><b>Authority:</b> ${escapeHtml(msg)}</div>`; document.getElementById('chatMsg').value='';
}

function escapeHtml(text){
  if(!text && text !== 0) return '';
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
</script>
</body>
</html>
